Bootstrap: library
From: ubuntu:18.04
Stage: build

%post
    # Get the date so we can timestamp the creation of the container
    NOW=`date`
    echo "export NOW=\"${NOW}\"" >> $SINGULARITY_ENVIRONMENT

    # Basic Package installation
    apt-get update && apt-get install -y wget tar git dpkg-dev cmake g++ gcc gfortran binutils libx11-dev libxpm-dev libxft-dev libxext-dev libxml2-dev python3-dev libssl-dev libpcre3-dev libglu1-mesa-dev libmysqlclient-dev libfftw3-dev libavahi-compat-libdnssd-dev libldap2-dev libxml2-dev libkrb5-dev
    cd /opt

    # CRY Setup
    wget https://nuclear.llnl.gov/simulation/cry_v1.7.tar.gz
    tar -xzvf cry_v1.7.tar.gz
    rm cry_v1.7.tar.gz
    cd cry_v1.7/
    make setup
    make lib
    cd /opt

    # Pythia 6 setup
    wget https://root.cern.ch/download/pythia6.tar.gz
    tar -xzvf pythia6.tar.gz
    rm -rf pythia6.tar.gz
    wget http://www.hepforge.org/archive/pythiasix/pythia-6.4.28.f.gz
    gzip -d pythia-6.4.28.f.gz
    mv pythia-6.4.28.f pythia6/pythia6428.f
    rm -rf pythia6/pythia6416.f
    cd pythia6
    ./makePythia6.linuxx8664
    cp libPythia6.so /usr/local/lib
    cd /opt

    # LHAPDF Setup, datasets are external to the container (/usr/local/share/LHAPDF)
    wget https://lhapdf.hepforge.org/downloads/LHAPDF-6.2.3.tar.gz
    tar -xzvf LHAPDF-6.2.3.tar.gz
    rm -rf LHAPDF-6.2.3.tar.gz
    cd LHAPDF-6.2.3
    ./configure
    make -j4
    make install
    cd /opt
    rm -rf LHAPDF-6.2.3

    # log4cpp Setup
    wget https://netcologne.dl.sourceforge.net/project/log4cpp/log4cpp-1.1.x%20%28new%29/log4cpp-1.1/log4cpp-1.1.3.tar.gz
    tar -xzvf log4cpp-1.1.3.tar.gz
    rm -rf log4cpp-1.1.3.tar.gz
    cd log4cpp
    ./configure
    make -j4
    make install
    cd /opt
    rm -rf log4cpp

    # GSL Setup
    wget ftp://ftp.gnu.org/gnu/gsl/gsl-2.6.tar.gz
    tar -xzvf gsl-2.6.tar.gz
    rm gsl-2.6.tar.gz
    cd gsl-2.6
    ./configure
    make -j4
    make install
    cd /opt
    rm -rf gsl-2.6

    # CLHEP Setup
    wget http://www.hep.ucl.ac.uk/~jtingey/clhep-2.1.0.1.tgz
    tar -xzvf clhep-2.1.0.1.tgz
    rm clhep-2.1.0.1.tgz
    cd 2.1.0.1/CLHEP/
    ./configure
    make -j4
    make install
    cd /opt
    rm -rf 2.1.0.1

    # ROOT setup
    wget https://root.cern.ch/download/root_v5.34.38.source.tar.gz
    tar -xzvf root_v5.34.38.source.tar.gz
    rm root_v5.34.38.source.tar.gz
    mkdir root-build
    cd root-build
    cmake -DPYTHIA6=ON -DPYTHIA6_LIBRARY=/opt/pythia6/libPythia6.so ../root/
    make -j4
    make install
    cd /opt
    rm -rf root-build root

    # GENIE Setup
    git clone https://github.com/GENIE-MC/Generator.git
    export GENIE=/opt/Generator
    export ROOTSYS=/usr/local
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib/
    export CPLUS_INCLUDE_PATH=$CPLUS_INCLUDE_PATH:/usr/local/include
    cd Generator
    ./configure --enable-lhapdf6 --enable-gfortran
    make -j4
    make install
    cd /opt
    rm -rf Generator

    # Geant4 Setup, datasets are external to the container
    wget http://www.hep.ucl.ac.uk/~jtingey/geant4.9.4.p02.tar.gz
    tar -xzvf geant4.9.4.p02.tar.gz
    rm geant4.9.4.p02.tar.gz
    mkdir geant4-build
    cd geant4-build
    cmake /opt/geant4.9.4.p02/
    make -j4
    make install
    cd /opt
    rm -rf geant4-build geant4.9.4.p02

    # GLoBES Setup
    wget https://www.mpi-hd.mpg.de/personalhomes/globes/download/globes-3.0.11.tar.gz
    tar -xzvf globes-3.0.11.tar.gz
    rm globes-3.0.11.tar.gz
    cd globes-3.0.11/
    ./configure
    make -j4
    make install
    cd /opt
    rm -rf globes-3.0.11

%runscript
    echo "chips-env container was created $NOW"

%labels
    Author j.tingey.16@ucl.ac.uk
    Version v1.0.0

%help
    This is a container packaging the full environment required for CHIPS software...
        - CRY (Cosmic event generation)
        - Pythia6 (Monte Carlo event generator)
        - LHAPDF6 (PDF interpolator)
        - log4cpp (Logging library)
        - GSL (Scientific software library)
        - CLHEP (HEP software utilities)
        - ROOT (Scientific analysis software toolkit)
        - GENIE (Beam event generation)
        - Geant4 (Detector simulation backend)
        - GLoBES (Simulation for long baseline neutrino oscillation experiments)
