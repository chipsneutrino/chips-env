Bootstrap: docker
From: continuumio/miniconda3:4.7.12-alpine

%labels
    name chips-conda

%files
    start.sh /usr/local/bin/
    env.yml /opt

%environment
    PATH=/opt/conda/envs/$(head -1 /opt/env.yml | cut -d' ' -f2)/bin:$PATH

%post
    # Setup the conda environment
    echo ". /opt/conda/etc/profile.d/conda.sh" >> ~/.bashrc
    echo "source activate $(head -1 /opt/env.yml | cut -d' ' -f2)" > ~/.bashrc
    /opt/conda/bin/conda env create -f /opt/env.yml
    /opt/conda/bin/conda clean -afy

    # Make start script executable
    chmod +x /usr/local/bin/start.sh

%runscript
    start.sh

